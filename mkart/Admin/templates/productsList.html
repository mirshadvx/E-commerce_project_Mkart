{% extends "Base.html" %}
{% load static %}

{% block title %}
Product list
{% endblock  %}

{% block extra_style %}
        <link rel="shortcut icon" type="image/x-icon" href="admin-assets/img/favicon.jpg" />

        <link rel="stylesheet" href="{% static 'admin-assets/css/bootstrap.min.css' %}" />

        <link rel="stylesheet" href="{% static 'admin-assets/css/animate.css' %}" />

        <link rel="stylesheet" href="{% static 'admin-assets/plugins/select2/css/select2.min.css' %}" />

        <link rel="stylesheet" href="{% static 'admin-assets/css/dataTables.bootstrap4.min.css' %}" />

        <link rel="stylesheet" href="{% static 'admin-assets/plugins/fontawesome/css/fontawesome.min.css' %}" />
        <link rel="stylesheet" href="{% static 'admin-assets/plugins/fontawesome/css/all.min.css' %}" />

        <link rel="stylesheet" href="{% static 'admin-assets/css/style.css' %}" />
        <style>
            .status-toggle.btn-success {
                background-color: #1ca61c;
                color: white;
                width: 100px;
            }

            .status-toggle.btn-danger {
                background-color: #dc3545;
                color: white;
            }
            .offer-select {
                width: 150px;
            }
        </style>
{% endblock  %}


{% block content %}
            <div class="page-wrapper">
                <div class="content">
                    <div class="page-header">
                        <div class="page-title">
                            <h4>Product List</h4>
                            <h6>Manage your products</h6>
                        </div>
                        <div class="page-btn">
                            <a href="{% url "addProduct" %}" class="btn btn-added"
                                ><img src="{% static 'admin-assets/img/icons/plus.svg' %}" alt="img" class="me-1" />Add New Product</a
                            >
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-top">
                                <div class="search-set">
                                    <div class="search-path">
                                        <a class="btn btn-filter" id="filter_search">
                                            <img src="{% static 'admin-assets/img/icons/filter.svg' %}" alt="img" />
                                            <span><img src="{% static 'admin-assets/img/icons/closes.svg' %}" alt="img" /></span>
                                        </a>
                                    </div>
                                    <div class="search-input">
                                        <a class="btn btn-searchset"
                                            ><img src="{% static 'admin-assets/img/icons/search-white.svg' %}" alt="img"
                                        /></a>
                                    </div>
                                </div>
                                <div class="wordset">
                                    <ul>
                                        <li>
                                            <a data-bs-toggle="tooltip" data-bs-placement="top" title="pdf"
                                                ><img src="{% static 'admin-assets/img/icons/pdf.svg' %}" alt="img"
                                            /></a>
                                        </li>
                                        <li>
                                            <a data-bs-toggle="tooltip" data-bs-placement="top" title="excel"
                                                ><img src="{% static 'admin-assets/img/icons/excel.svg' %}" alt="img"
                                            /></a>
                                        </li>
                                        <li>
                                            <a data-bs-toggle="tooltip" data-bs-placement="top" title="print"
                                                ><img src="{% static 'admin-assets/img/icons/printer.svg' %}" alt="img"
                                            /></a>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card mb-0" id="filter_inputs">
                                <div class="card-body pb-0">
                                    <div class="row">
                                        <div class="col-lg-12 col-sm-12">
                                            <div class="row">
                                                <div class="col-lg col-sm-6 col-12">
                                                    <div class="form-group">
                                                        <select class="select">
                                                            <option>Choose Product</option>
                                                            <option>Macbook pro</option>
                                                            <option>Orange</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg col-sm-6 col-12">
                                                    <div class="form-group">
                                                        <select class="select">
                                                            <option>Choose Category</option>
                                                            <option>Computers</option>
                                                            <option>Fruits</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg col-sm-6 col-12">
                                                    <div class="form-group">
                                                        <select class="select">
                                                            <option>Choose Sub Category</option>
                                                            <option>Computer</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg col-sm-6 col-12">
                                                    <div class="form-group">
                                                        <select class="select">
                                                            <option>Brand</option>
                                                            <option>N/D</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg col-sm-6 col-12">
                                                    <div class="form-group">
                                                        <select class="select">
                                                            <option>Price</option>
                                                            <option>150.00</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-lg-1 col-sm-6 col-12">
                                                    <div class="form-group">
                                                        <a class="btn btn-filters ms-auto"
                                                            ><img src="{% static 'admin-assets/img/icons/search-whites.svg' %}" alt="img"
                                                        /></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table datanew">
                                    <thead>
                                        <tr>
                                            <th>
                                                <label class="checkboxs">
                                                    <input type="checkbox" id="select-all" />
                                                    <span class="checkmarks"></span>
                                                </label>
                                            </th>
                                            <th>Product Name</th>
                                            <th>Category</th>
                                            <th>Gender</th>
                                            <th>Brand</th>
                                            <th>Color</th>
                                            <th>Price</th>
                                            <th>Qty</th>
                                            <th>Offer</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
 
<tbody>
    {% for product in products %}
    {% for variant in product.variants.all %}
    <tr>
        <td>
            <label class="checkboxs">
                <input type="checkbox" />
                <span class="checkmarks"></span>
            </label>
        </td>
        <td class="productimgname">
            <a href="javascript:void(0);" class="product-img">
                {% if variant.image_1 %}
                    <img src="{{ variant.image_1.url }}" alt="{{ product.name }}" />
                {% else %}
                    <img src="{% static 'path/to/default/image.jpg' %}" alt="{{ product.name }}" />
                {% endif %}
            </a>
            <a href="javascript:void(0);">{{ product.name }}</a>
        </td>
        <td>{{ product.category.name }}</td>
        <td>{{ product.gender.name }}</td>
        <td>{{ product.brand.name }}</td>
        <td>{{ variant.color.name }}</td>
        <td>{{ variant.price }}</td>
        <td>{{ variant.stock }}</td>
                    <td>
                        <select style="height: 2em;" class="offer-select" data-variant-id="{{ variant.id }}">
                            <option value="">Select offer</option>
                            {% for offer in offers %}
                            <option value="{{ offer.id }}" {% if variant.offer_id == offer.id %}selected{% endif %}>
                                <strong>{{ offer.name }} | {{ offer.discount }}%</strong>
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    
<td>
    <button class="btn btn-sm status-toggle {% if variant.is_available %}btn-success{% else %}btn-danger{% endif %}" 
            data-variant-id="{{ variant.id }}">
        {% if variant.is_available %}Available{% else %}Not Available{% endif %}
    </button>
</td>
        <td>
            <a class="me-3">
                <img src="{% static 'admin-assets/img/icons/eye.svg' %}" alt="img" />
            </a>
            <a class="me-3" href="{% url 'edit_product' product.id %}">
                <img src="{% static 'admin-assets/img/icons/edit.svg' %}" alt="img" />
            </a>
            <a href="{% url 'add_variant' product.id %}">
             <button  class="btn btn-sm btn-primary">add variant</button></a>
        </td>
    </tr>
    {% endfor %}
    {% endfor %}
</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
{% endblock  %}

{% block extra_js %}
        <script src="{% static 'admin-assets/js/jquery-3.6.0.min.js' %}"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="{% static 'admin-assets/js/feather.min.js' %}"></script>

        <script src="{% static 'admin-assets/js/jquery.slimscroll.min.js' %}"></script>

        <script src="{% static 'admin-assets/js/jquery.dataTables.min.js' %}"></script>
        <script src="{% static 'admin-assets/js/dataTables.bootstrap4.min.js' %}"></script>

        <script src="{% static 'admin-assets/js/bootstrap.bundle.min.js' %}"></script>

        <script src="{% static 'admin-assets/plugins/select2/js/select2.min.js' %}"></script>

        <script src="{% static 'admin-assets/plugins/sweetalert/sweetalert2.all.min.js' %}"></script>
        <script src="{% static 'admin-assets/plugins/sweetalert/sweetalerts.min.js' %}"></script>

        <script src="{% static 'admin-assets/js/script.js' %}"></script> 
        
<script>
    $(document).ready(function() {
        $('.offer-select').on('change', function() {
            var select = $(this);
            var variantId = select.data('variant-id');
            var offerId = select.val();

            $.ajax({
                url: '{% url "update_variant_offer" %}',
                type: 'POST',
                data: {
                    'variant_id': variantId,
                    'offer_id': offerId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        const Toast = Swal.mixin({
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 4000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;
                        }
                        });
                        Toast.fire({
                        icon: "success",
                        title: "Offer updated successfully"
                        });
                        
                    } else {
                        alert('Failed to update offer');
                    }
                },
                error: function() {
                    alert('An error occurred while updating the offer');
                }
            });
        });
    });
</script>        


<script>
$(document).ready(function() {
    $('.status-toggle').on('click', function() {
        var button = $(this);
        var variantId = button.data('variant-id');

        $.ajax({
            url: '{% url "toggle_variant_availability" %}',  // Update this URL name
            type: 'POST',
            data: {
                'variant_id': variantId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    button.text(response.status_text);
                    button.toggleClass('btn-success btn-danger');
                } else {
                    alert('Failed to update status');
                }
            },
            error: function() {
                alert('An error occurred while updating the status');
            }
        });
    });
});
</script>
{% endblock  %}
